<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="RegistroInversion">
    
    <resultMap id="resultado" type="String">
        <result property="nombre_exp" column="NUMERODOCU"/>
    </resultMap>
    
    <resultMap id="resultado2" type="String">
        <result property="nombre_exp" column="IDEXP"/>
    </resultMap>
    
    <resultMap id="resultado21" type="Integer">
        <result property="idproye" column="IDEXP"/>
    </resultMap>
    
    <resultMap id="resultado3" type="Integer">
        <result property="id" column="IDRORDR"/>
    </resultMap>
    
    <resultMap id="resultado4" type="String">
        <result property="etapa" column="ETAPA"/>
    </resultMap>
    
    <resultMap id="resultado5" type="Integer">
        <result property="idproyexpt" column="IDPROYEXPT"/>
    </resultMap>
    
    <resultMap id="resultado6" type="Integer">
        <result property="validar" column="CANTIDAD"/>
    </resultMap>
    
    <resultMap id="resultado7" type="gp.model.EjecucionMostrado">
        <result property="nombreTipoDocu" column="NOMBRETIPODOCU"/>
        <result property="nombRoRdR" column="RORDR"/>
        <result property="mes" column="MES"/>
        <result property="anio" column="ANIO"/>
        <result property="monto" column="MONTOEJECUTADO"/>
        <result property="monto2" column="MONTOPRELIMINAR"/>
    </resultMap>
    
    <resultMap id="resultado8" type="gp.model.Componentes">
        <result property="montoExpTec" column="EXP_TECN"/>
        <result property="montoInfra" column="INFRAESTRUCTURA"/>
        <result property="montoEquipMov" column="EQUIP_MOBIL"/>
        <result property="montoSuperv" column="SUPERVISION"/>
        <result property="montoCapac" column="CAPACITACION"/>
        <result property="montoOtros" column="OTROS"/>
        <result property="fecharegistro" column="FECHA_REG"/>
        <result property="montoModif" column="MONTO_MODIF"/>
        <result property="tipoRegistro" column="TIPO_REG"/>
        <result property="codigoProy" column="ID_PROYECTO"/>
        <result property="numMonto" column="NUM_MONTO"/>
        <result property="idExpTecn" column="PEXPTECN"/>
    </resultMap>
    
    
    <select id="getNumeroExp" resultMap="resultado" parameterType="java.util.HashMap">
        SELECT MAX(PE.NUMERO_EXP)+1 AS NUMERODOCU FROM PROY_EXPT PE, TIPOS_DOCUMENTOS TD
        WHERE PE.ID_TIPOSDOCUS=TD.ID_TIPOSDOCUS
        AND PE.ID_PROYECTO=#{codigo}
        AND TD.ID_TIPOSDOCUS=#{tipo}
    </select>
    
    <select id="getNumeroDocumento" resultMap="resultado" parameterType="java.util.HashMap">
        SELECT MAX(ND.NUMERO_DOCU)+1 AS NUMERODOCU FROM NUEVOS_DOCUMENTOS ND, PROY_EXPT PE, TIPOS_DOCUMENTOS TD
        WHERE ND.ID_PROYEXPT=PE.ID_PROYEXPT
        AND PE.ID_PROYECTO=#{codigo}
        AND ND.ID_TIPOSDOCUS=#{tipo}
        AND PE.NUMERO_EXP=#{numeroExp}
        AND ND.ID_TIPOSDOCUS=TD.ID_TIPOSDOCUS
    </select>
    
    <select id="getListaExp" resultMap="resultado" parameterType="java.util.HashMap">
        SELECT TD.NOMBRE_TIPODOCU||' NÂ° '||PE.NUMERO_EXP AS NUMERODOCU FROM PROY_EXPT PE, TIPOS_DOCUMENTOS TD
        WHERE PE.ID_TIPOSDOCUS=TD.ID_TIPOSDOCUS
        AND PE.ID_PROYECTO=#{codigo}
        AND TD.ID_TIPOSDOCUS=#{tipo}
        GROUP BY TD.NOMBRE_TIPODOCU,PE.NUMERO_EXP
        ORDER BY PE.NUMERO_EXP
    </select>
    
    <insert id="insert_nuevoExp" parameterType="gp.model.NuevosDocumentos">
        INSERT INTO PROY_EXPT (NUMERO_EXP,ID_PROYECTO,ID_TIPOSDOCUS,ETAPA)
        VALUES (#{numeroDocu},#{idProy},#{tipodocu},#{etapa})
    </insert>
    <insert id="guardar_historial" parameterType="gp.model.Historial">
        INSERT INTO HISTORIALEXPCONT (MONTO,FECHA,NUMERO_RR,ID_PROYEXPT)
        VALUES (#{monto},#{fecha},#{resolucion},#{idproy})
    </insert>
    
    <insert id="guardar_historialAdicDeduc" parameterType="gp.model.Historial">
        INSERT INTO HISTORIALEXPCONT (MONTO,FECHA,NUMERO_RR,ID_NUEVDOC)
        VALUES (#{monto},#{fecha},#{resolucion},#{idnuevodoc})
    </insert>
    
    <insert id="guardar_historialContrato" parameterType="gp.model.Historial">
        INSERT INTO HISTORIALEXPCONT (MONTO,FECHA,ID_NUEVDOC)
        VALUES (#{monto},#{fecha},#{idproy})
    </insert>
    
    <insert id="insert_nuevoDoc" parameterType="gp.model.NuevosDocumentos">
        INSERT INTO NUEVOS_DOCUMENTOS (NUMERO_DOCU,ID_TIPOSDOCUS,ID_PROYEXPT)
        VALUES (#{numeroDocu},#{tipodocu},#{exptecn})
    </insert>
    
    <insert id="insert_nuevoDocContrato" parameterType="gp.model.NuevosDocumentos">
        INSERT INTO NUEVOS_DOCUMENTOS (CODIGO_DOCU,ID_TIPOSDOCUS,ID_PROYEXPT)
        VALUES (#{codigoContrato},#{tipodocu},#{exptecn})
    </insert>
    
    <select id="getIdExpTecn" resultMap="resultado2" parameterType="java.util.HashMap">
        SELECT ID_PROYEXPT AS IDEXP FROM PROY_EXPT
        WHERE ID_PROYECTO=#{codigo}
        AND ID_TIPOSDOCUS=#{tipo}
        AND NUMERO_EXP=#{numero}
    </select>
    
    <select id="getIdProyectoExpt" resultMap="resultado21" parameterType="java.util.HashMap">
        SELECT ID_PROYEXPT AS IDEXP FROM PROY_EXPT
        WHERE ID_PROYECTO=#{idproy}
        AND ETAPA=#{etapa}
        AND NUMERO_EXP=#{numero}
    </select>
    
    <select id="getIdNuevosDocus" resultMap="resultado21" parameterType="java.util.HashMap">
        SELECT ID_NUEVDOC AS IDEXP
        FROM NUEVOS_DOCUMENTOS
        WHERE CODIGO_DOCU=#{numerocontrato}
        AND ID_PROYEXPT=#{idexpt}
        AND ID_PROYEXPT IN (SELECT P.ID_PROYEXPT FROM PROY_EXPT P WHERE P.ID_PROYECTO=#{idproy})
    </select>
    
    <select id="getIdNuevosDocus2" resultMap="resultado21" parameterType="java.util.HashMap">
        SELECT ID_NUEVDOC AS IDEXP
        FROM NUEVOS_DOCUMENTOS
        WHERE NUMERO_DOCU=#{numerodocu}
        AND ID_PROYEXPT=#{exptecn}
        AND ID_TIPOSDOCUS=#{tipodocu}
    </select>
    
    
    <insert id="insert_nuevaEjec" parameterType="gp.model.Ejecucion">
        INSERT INTO EJECUCION (MES,ANIO,MONTO,ID_TIPOSDOCUS,ID_RORDR,FECHA,MONTO2,ID_PROYEXPT)
        VALUES (#{mes},#{anio},#{monto},#{idTiposDocus},#{idRORDR},#{fecha},#{monto2},#{idProyectoExpt})
    </insert>
    
    <update id="updateEjec" parameterType="gp.model.Ejecucion">
        UPDATE EJECUCION
        SET
        MES=#{mes},
        ANIO=#{anio},
        MONTO=#{monto},
        ID_RORDR=#{idRORDR},
        MONTO2=#{monto2}
        WHERE ID_PROYEXPT = #{idProyectoExpt}
        and ID_TIPOSDOCUS=#{idTiposDocus}
    </update>
    
    <select id="validarProy" resultMap="resultado2" parameterType="String">
        SELECT ID_PROYECTO AS IDEXP FROM PROYECTO
        WHERE ID_PROYECTO=#{codigo}
    </select>
    
    <select id="getListaCoincidencia" resultMap="resultado2" parameterType="String">
        SELECT ID_PROYECTO AS IDEXP FROM PROYECTO
        WHERE ID_PROYECTO LIKE '%'||#{codigo}||'%' 
    </select>
    
    <select id="getIdrordr" resultMap="resultado3" parameterType="String">
        SELECT ID_RORDR AS IDRORDR FROM RO_RDR
        WHERE NOMBRE=#{nombre}
    </select>
    
    <select id="getListaEtapas" resultMap="resultado4" parameterType="String">
        SELECT ETAPA AS ETAPA FROM PROY_EXPT
        WHERE ID_PROYECTO=#{idproy}
        ORDER BY ETAPA ASC
    </select>
    
    <select id="getIdProyExpt" resultMap="resultado5" parameterType="String">
        SELECT ID_PROYEXPT AS IDPROYEXPT FROM PROY_EXPT
        WHERE ID_PROYECTO=#{codigo}
        AND ETAPA=#{etapa}
    </select>
    
    <select id="validarProy2" resultMap="resultado6" parameterType="java.util.HashMap">        
        SELECT COUNT(*) AS CANTIDAD
        FROM PROY_EXPT PE, EJECUCION E
        WHERE PE.ID_PROYECTO=#{codigo}
        AND PE.ETAPA=#{etapa}
        AND PE.ID_PROYEXPT=E.ID_PROYEXPT
    </select>
    
    <select id="getMontosEjecutados" resultMap="resultado7" parameterType="String">
        SELECT TD.NOMBRE_TIPODOCU as NOMBRETIPODOCU,
        RD.NOMBRE AS RORDR,
        E.MES AS MES, 
        E.ANIO AS ANIO,
        E.MONTO AS MONTOEJECUTADO,
        E.MONTO2 AS MONTOPRELIMINAR
        FROM EJECUCION E, PROY_EXPT PE, TIPOS_DOCUMENTOS TD, RO_RDR RD
        WHERE E.ID_PROYEXPT=PE.ID_PROYEXPT
        AND E.ID_TIPOSDOCUS=TD.ID_TIPOSDOCUS
        AND E.ID_RORDR=RD.ID_RORDR
        AND PE.ID_PROYECTO=#{codigo}
        AND PE.ID_PROYEXPT=#{id}
    </select>
    
    <insert id="ingresar_infraestructura" parameterType="gp.model.Componentes">
        INSERT INTO COMPONENTES (EXP_TECN,INFRAESTRUCTURA,EQUIP_MOBIL,SUPERVISION,CAPACITACION,OTROS,FECHA_REG,MONTO_MODIF,TIPO_REG,ID_PROYECTO,NUM_MONTO,ID_PROYEXPT)
        VALUES (#{montoExpTec},#{montoInfra},#{montoEquipMov},#{montoSuperv},#{montoCapac},#{montoOtros},#{fecharegistro},#{montoModif},#{tipoRegistro},#{codigoProy},#{numMonto},#{idExpTecn})
    </insert>
    
    <insert id="agregar_monto_et" parameterType="gp.model.Historial">
        INSERT INTO HISTORIALEXPCONT (MONTO,FECHA,NUMERO_RR,ID_PROYEXPT)
        VALUES (#{monto},#{fecha},#{resolucion},#{idproy})
    </insert>
    
    <select id="getMontosPorEtapa" resultMap="resultado8" parameterType="java.util.Map">
        SELECT CO.EXP_TECN AS EXP_TECN,
        CO.INFRAESTRUCTURA AS INFRAESTRUCTURA,
        CO.EQUIP_MOBIL AS EQUIP_MOBIL,
        CO.SUPERVISION AS SUPERVISION,
        CO.CAPACITACION AS CAPACITACION,
        CO.OTROS AS OTROS,
        CO.FECHA_REG AS FECHA_REG,
        CO.MONTO_MODIF AS MONTO_MODIF,
        CO.TIPO_REG AS TIPO_REG,
        CO.ID_PROYECTO AS ID_PROYECTO,
        CO.NUM_MONTO AS NUM_MONTO,
        CO.ID_PROYEXPT AS PEXPTECN
        FROM COMPONENTES CO, PROY_EXPT PE
        WHERE CO.ID_PROYEXPT=PE.ID_PROYEXPT
        AND CO.ID_PROYECTO=#{codigo}
        AND PE.ETAPA=#{etapa}
        AND CO.NUM_MONTO IN ( SELECT MAX(COMP.NUM_MONTO) 
                              FROM COMPONENTES COMP, 
                              PROY_EXPT PROYEXPT
                              WHERE COMP.ID_PROYECTO=#{codigo}
                              AND COMP.ID_PROYEXPT=PROYEXPT.ID_PROYEXPT 
                              AND PROYEXPT.ETAPA=#{etapa})
        ORDER BY CO.NUM_MONTO ASC
    </select>
    
</mapper>
